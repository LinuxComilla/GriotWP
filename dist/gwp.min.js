angular.module("griot",[]),jQuery(document).ready(function(){jQuery("#poststuff").attr({"ng-app":"griot","ng-controller":"griotCtrl"}).find("#post-body-content").append("<div id='griot'><textarea name='content' id='griot-data'>{{ data | json }}</textarea><fieldset><field type='text' name='objectid' label='Object ID' /></fieldset><div media-drawer></div></div>").find("#title").attr({"ng-model":"data.title"}),angular.bootstrap(document,["griot"])}),jQuery(document).ready(function(){jQuery("input[name='griot_tile_server']").on("change",function(e){if(!e.target.value)return void jQuery("#griot-tile-server-response").fadeOut(200,function(){jQuery(this).removeClass("error success").html("")});jQuery("#griot-tile-server-response").removeClass("success error").html("Fetching config ...").fadeIn(200);var t={action:"griot_get_config",config_url:e.target.value};jQuery.post(ajaxurl,t,function(e){if("error"===e)return void jQuery("#griot-tile-server-response").removeClass("success").addClass("error").html("<strong>Error:</strong> The tile server config cannot be read. It may be missing, inaccessible, or malformed.").fadeIn(200);var t=JSON.parse(e),n=0,i=0;console.log(t);for(var a in t.objects)!isNaN(parseFloat(a))&&isFinite(a)&&n++;i=t.all.length,jQuery("#griot-tile-server-response").removeClass("error").addClass("success").html("<strong>Success!</strong> Found <strong>"+n+"</strong> objects and <strong>"+i+"</strong> zoomable images.").fadeIn(200)})}),jQuery("#griot-image-source-setting-external").is(":checked")?jQuery("#griot-image-list-setting").closest("tr").show():jQuery("#griot-image-list-setting").closest("tr").hide(),jQuery("input[name='griot_image_source']").on("change",function(){jQuery("#griot-image-source-setting-external").is(":checked")?jQuery("#griot-image-list-setting").closest("tr").fadeIn(100):jQuery("#griot-image-list-setting").closest("tr").fadeOut(100)})}),angular.module("griot").controller("griotCtrl",["$scope","$http","ModelChain",function(e,t,n){if(n.initialize(e),e.data=griotData.data?JSON.parse(griotData.data):{},e.data.title=griotData.title,e.ui={recordType:griotData.recordType,oppositeRecordType:"object"==griotData.recordType?"story":"object",recordList:griotData.recordList,tileServer:griotData.tileServer,zoomables:griotData.config,objects:[]},griotData.config)for(var i in griotData.config.objects)"null"!==i&&"_empty_"!==i&&e.ui.objects.push(i);else console.log("WARNING: No config detected!")}]),angular.module("griot").directive("annotations",["$timeout","$compile",function(e,t){return{restrict:"A",require:["repeater","^zoomer"],link:function(e,n,i,a){var o=this,r=a[0],s=a[1],l=s.getScope(),c=angular.element("<a class='griot-button' ng-show='hasMap()' ng-click='zoomOut()'>Zoom Out</a>"),d=t(c);n.find(".griot-button").first().replaceWith(c),d(l),e.$watch(function(){return r.getActiveIndex()},function(){var e=s.getZoomer(),t=s.getAnnotations();if(t[r.getActiveIndex()]){var n=t[r.getActiveIndex()].geoJSON,i=L.GeoJSON.geometryToLayer(n.geometry);e&&e.map.fitBounds(i)}}),e.$watch(function(){return s.getZoomer()},function(t){t&&(angular.forEach(s.getImageLayers()._layers,function(e){e.on("click",function(e){if(!o.deleting){var t=e.target.annotation,n=jQuery.inArray(t,s.getAnnotations());r.swipeTo(n)}})}),t.map.on("draw:deletestart",function(){o.deleting=!0}),t.map.on("draw:deletestop",function(){o.deleting=!1}),t.map.on("draw:created",function(n){var i=n.layer.toGeoJSON();e.$apply(function(){var e=s.getAnnotations().push({geoJSON:i}),n=s.getAnnotations()[e-1],a=L.GeoJSON.geometryToLayer(i.geometry);a.annotation=n,s.getImageLayers().addLayer(a),t.map.fitBounds(a),a.on("click",function(e){if(!o.deleting){var t=e.target.annotation,n=jQuery.inArray(t,s.getAnnotations());r.swipeTo(n)}})})}),t.map.on("draw:deleted",function(t){var n=r.getRepeater(),i=r.getActiveIndex(),a=0,o=[],l=[];angular.forEach(t.layers._layers,function(e){var t=jQuery.inArray(e.annotation,s.getAnnotations());l.push(t)}),angular.forEach(s.getAnnotations(),function(e,t){-1===jQuery.inArray(t,l)&&o.push(t)}),l.reverse();for(var c=0;c===l.length&&0!==i;c++)i===l[c]&&i--;angular.forEach(o,function(e,t){i===e&&(a=t)}),angular.forEach(l,function(t){e.$apply(function(){s.getAnnotations().splice(t,1)})}),n.swipeTo(a,0,!1)}),t.map.on("draw:edited",function(t){angular.forEach(t.layers._layers,function(t){var n=t.toGeoJSON();e.$apply(function(){t.annotation.geoJSON=n})})}))})}}}]),angular.module("griot").directive("ckEditor",function(){return{restrict:"A",require:["?^repeater","?ngModel"],link:function(e,t,n,i){var a=i[0],o=i[1],r=CKEDITOR.replace(t[0],{allowedContent:!0});a&&r.on("instanceReady",function(){a.refresh()}),r.on("pasteState",function(){e.$apply(function(){o.$setViewValue(r.getData())})}),o.$render=function(){r.setData(o.$viewValue)},n.hasOwnProperty("protected")&&r.on("instanceReady",function(){e.$watch("protected",function(e){r.setReadOnly(e)})})}}}),angular.module("griot").directive("field",function(){return{restrict:"E",replace:!0,scope:{data:"=",ui:"="},controller:["$scope","$element","$attrs","ModelChain",function(e,t,n,i){e.griotData=griotData,e.protected=!1,e.toggleProtection=function(){e.protected=!e.protected},n.hasOwnProperty("bypassmodel")?i.bypassModel(e):i.updateModel(e,n.name)}],template:function(e,t){var n;switch(t.type){case"objectselector":n="<select ng-model='model."+t.name+"' ng-options='object for object in ui.objects' ng-disabled='protected'><option value=''>None</option></select>";break;case"text":n="<input type='text' ng-model='model."+t.name+"' ng-disabled='protected' />";break;case"textarea":n="<textarea ng-model='model."+t.name+"' ng-disabled='protected' ></textarea>";break;case"wysiwyg":n="<textarea ng-model='model."+t.name+"' ck-editor ng-disabled='protected' ></textarea>";break;case"zoomer":t.bypassmodel="bypassmodel";var i=e.html();n="<zoomer name='"+t.name+"' object='"+t.object+"' annotations-name='"+t.annotationsName+"' annotations-label='"+t.annotationsLabel+"' annotations-label-singular='"+t.annotationsLabelSingular+"' annotations-label-plural='"+t.annotationsLabelPlural+"'>"+i+"</zoomer>";break;case"zoomerselector":n="<select ng-model='model."+t.name+"' ng-options='object for object in ( ui.objects | filterObjects : ui : data."+t.object+" )' ng-disabled='protected'><option value=''>None</option></select>";break;case"relationship":n="<select ng-model='model."+t.name+"' ng-options='( record.ID | parseInt ) as ( record | getTitle ) for record in ui.recordList[ ui.oppositeRecordType ]' multiple ng-disabled='protected' ></select>";break;case"image":n="<imagepicker name='"+t.name+"' />";break;case"select":var a=[];$options=jQuery(e).find("option"),$options.each(function(e,t){a.push({value:jQuery(t).val(),label:jQuery(t).text(),selected:jQuery(t).prop("selected")})}),t.jsonFieldOptions=angular.toJson(a),n="<select ng-model='model."+t.name+"' ng-options='option.value as option.label for option in fieldOptions'></select>";break;case"checkbox":n="<input type='checkbox' ng-model='model."+t.name+"' />"}var o="<div class='griot-field-wrap' ng-class='{ \"griot-protected\": protected }' data='data' ui='ui' ng-hide='attrs.hidden'><div class='griot-field-meta'>";return t.hasOwnProperty("label")&&(o+="<span class='griot-label'>"+t.label+"</span>"),t.hasOwnProperty("protected")&&(o+="<a class='griot-button' ng-if='protected' ng-click='toggleProtection()'>Unlock</a><a class='griot-button' ng-if='!protected' ng-click='toggleProtection()'>Lock</a>"),o+="</div><div class='griot-field'>"+n+"</div></div>"},link:function(e,t,n){if("undefined"!=typeof n.autofill)try{e.model[n.name]=e.$eval(n.autofill)}catch(i){console.log("Autofill error on "+n.name+":"+i)}switch(n.type){case"select":e.fieldOptions=angular.fromJson(n.jsonFieldOptions),e.model[n.name]||angular.forEach(e.fieldOptions,function(t){t.selected&&(e.model[n.name]=t.value)})}}}}),angular.module("griot").directive("fieldset",function(){return{restrict:"E",replace:!0,templateUrl:function(){return griotData.templateUrl}}}),angular.module("griot").directive("griotRepeaterFields",["$timeout",function(e){return{restrict:"C",require:"^repeater",link:function(t,n,i,a){t.$last&&(a.refresh(),e(function(){a.stopInitializing()})),t.$watch(function(){return n.height()},function(e,t){e!=t&&a.refresh()}),n.find("input,textarea").last().on("keydown",function(e){return 9!==e.keyCode||e.shiftKey!==!1||repeater.nextDisabled()?9!==e.keyCode||e.shiftKey!==!0||repeater.prevDisabled()?void 0:(repeater.prevFocus(),!1):(repeater.nextFocus(),!1)})}}}]),angular.module("griot").directive("imagepicker",["$compile",function(e){return{restrict:"E",replace:!0,template:function(){var e="<div class='griot-imagepicker' >";return"external"===griotData.imageSrc&&(e+="<div class='griot-image-chooser' ng-class='{active: angframe.isOpen}'><img class='griot-image-thumbnail' ng-repeat='imageUrl in imageList' ng-src='{{ imageUrl }}' ng-click='angframe.select( imageUrl )' /></div>"),e+="<div class='griot-current-image' ng-class='{empty: !hasImage }' ng-style='{ backgroundImage: backgroundImage }' ng-click='openFrame()'></div></div>"},controller:["$scope","$element","$attrs",function(e,t,n){e.hasImage=e.model[n.name],e.backgroundImage=e.model[n.name]?"url("+e.model[n.name]+")":"auto",e.isImageTarget=!1,e.wpmframe=wp.media.griotImageLibrary.frame(),e.wpmframe.on("select",function(){if(e.isImageTarget){var t=e.wpmframe.state().get("selection");t.each(function(t){t.attributes.url&&e.$apply(function(){e.model[n.name]=t.attributes.url,e.backgroundImage="url("+t.attributes.url+")",e.isImageTarget=!1,e.hasImage=!0})})}}),e.imageList=griotData.imageList,e.angframe={isOpen:!1,select:function(t){t&&(e.model[n.name]=t,e.backgroundImage="url("+t+")",e.isImageTarget=!1,e.hasImage=!0),e.angframe.close()},open:function(){e.angframe.isOpen=!0},close:function(){e.angframe.isOpen=!1},toggle:function(){e.angframe.isOpen=!e.angframe.isOpen}},e.openFrame=function(){e.protected||("wordpress"===griotData.imageSrc?e.wpmframe.open():e.angframe.toggle(),e.isImageTarget=!0)},e.removeImage=function(){e.protected||(e.model[n.name]=null,e.hasImage=!1,e.backgroundImage="auto",e.angframe.close())}}],link:function(t,n){var i=angular.element("<a class='griot-button griot-pick-image' ng-disabled='protected' ng-click='openFrame()' ng-if='!hasImage'>Choose image</a><a class='griot-button griot-pick-image' ng-disabled='protected' ng-click='openFrame()' ng-if='hasImage'>Change image</a><a class='griot-button griot-remove-image' ng-disabled='protected' ng-if='hasImage' ng-click='removeImage()'>Remove image</a>"),a=e(i);n.closest(".griot-field-wrap").find(".griot-field-meta").append(i),a(t)}}}]),wp.media.griotImageLibrary={frame:function(){return this._frame?this._frame:(this._frame=wp.media({id:"griot-library-frame",title:"Insert an image",multiple:!1,editing:!0,library:{type:"image"},button:{text:"Insert"}}),this._frame)}},angular.module("griot").directive("mediaDrag",function(){return function(e,t){t.draggable({helper:"clone",scroll:!1,revert:"invalid",revertDuration:300})}}),angular.module("griot").directive("mediaDrawer",["$http",function(e){return{restrict:"A",replace:!0,template:"<div class='griot-media-drawer' ng-class=\"{'visible':drawerVisible}\" ng-click=''><div class='griot-media-controls'><h2>Available Media</h2><input class='griot-media-search' type='text' ng-model='mediaSearch.meta' id='griot-media-search' placeholder='Search media' /><input class='griot-media-filter-by-object' type='checkbox' ng-model='filterByObject' id='griot-media-filter-by-object' /><label class='griot-media-label' for='griot-media-filter-by-object'>Current object media only</label></div><div class='griot-media-window'><div class='griot-media-thumb' ng-repeat='image in media | filterMediaByObject:filterByObject:data.id | filter:mediaSearch | limitTo:20' ><img class='griot-media-image' ng-src='{{image.thumb}}' data-object-id='{{image.object_id}}' data-image-id='{{image.id}}' media-drag /></div></div></div>",controller:["$scope","$element","$attrs",function(t){var n;t.drawerVisible=!0,t.media=[],t.logStart=function(){console.log("start")},e.get("http://author.loc/wp-content/plugins/GriotWP/tdx_rev.json").success(function(e){n=e}).then(function(){for(var e in n)for(var i=n[e].images,a=n[e].meta,o=0;o<i.length;o++){var r=i[o];r.object_id=e,r.id=r.file.split(".tif")[0],r.thumb="http://tiles.dx.artsmia.org/v2/"+r.file.split(".tif")[0]+"/0/0/0.png",r.meta=[a.artist,a.continent,a.country,a.creditline,a.culture,a.description,a.medium,a.title].join(" "),t.media.push(r)}})}],link:function(){}}}]),angular.module("griot").directive("repeater",["$timeout",function(){return{restrict:"E",replace:!0,scope:{data:"=",ui:"="},transclude:!0,controller:["$scope","$element","$attrs","$timeout","ModelChain",function(e,t,n,i,a){a.updateModel(e,n.name),e.showMenu=!1,e.prevDisabled=!0,e.nextDisabled=!0,e.initializing=!0,e.register=function(t){e.model.hasOwnProperty(t)||(e.model[t]=[])},e.build=function(t){var n=t.find(".swiper-container").first().swiper({calculateHeight:!0,pagination:t.find(".griot-repeater-pagination").first()[0],paginationClickable:!0,paginationElementClass:"griot-repeater-bullet",paginationActiveClass:"active",onSlideChangeStart:function(){e.refreshNav()},onSlideChangeEnd:function(){e.$broadcast("slideChange")},onInit:function(){e.$broadcast("slidesReady")},noSwiping:!0,noSwipingClass:"griot-prevent-swipe"});e.repeater=n},e.refreshNav=function(){i(0===e.repeater.activeIndex?function(){e.prevDisabled=!0}:function(){e.prevDisabled=!1}),i(e.repeater.activeIndex===e.repeater.slides.length-1?function(){e.nextDisabled=!0}:function(){e.nextDisabled=!1})},e.refresh=function(){i(function(){var t=e.repeater.slides.length;e.repeater.reInit();var n=e.repeater.slides.length;e.repeater.swipeTo(n>t&&!e.initializing?n-1:e.repeater.activeIndex),e.refreshNav()})},e.add=function(t){e.showMenu=!1,t.push({})},e.remove=function(t,n){e.showMenu=!1,t.splice(n,1)},e.rearrange=function(t,n,a){t.splice(a,0,t.splice(n,1)[0]),i(function(){e.repeater.swipeTo(a)})},e.toggleMenu=function(){e.showMenu=!e.showMenu},e.swipeToActive=function(){i(function(){e.repeater.swipeTo(e.repeater.activeIndex)})},this.refresh=function(){e.refresh()},this.add=function(t){e.add(t)},this.nextFocus=function(){e.nextDisabled||(e.repeater.swipeNext(),setTimeout(function(){jQuery(e.repeater.slides[e.repeater.activeIndex]).find("input,textarea").first().focus()},e.repeater.params.speed+10))},this.prevFocus=function(){e.prevDisabled||(e.repeater.swipePrev(),setTimeout(function(){jQuery(e.repeater.slides[e.repeater.activeIndex]).find("input,textarea").last().focus()},e.repeater.params.speed+10))},this.nextDisabled=function(){return e.nextDisabled},this.prevDisabled=function(){return e.prevDisabled},this.getActiveIndex=function(){return e.repeater.activeIndex},this.getRepeater=function(){return e.repeater},this.swipeTo=function(t){i(function(){e.repeater.swipeTo(t)})},this.stopInitializing=function(){e.initializing=!1}}],template:function(e,t){return"<div class='griot-field-wrap' data='data' ui='ui'><p class='griot-field-meta'><span class='griot-label'>"+t.label+"</span> <a class='griot-button' ng-click='add( model."+t.name+', "'+t.name+"\" )' >Add "+t.labelSingular+"</a></p><div class='griot-repeater'><div class='griot-repeater-header' ng-show='repeater.slides.length !== 0'><div class='griot-repeater-pagination'></div><span class='griot-repeater-nav griot-icon griot-icon-prev prev' ng-click='repeater.swipePrev()' ng-class=\"{'disabled':prevDisabled}\"></span><span class='griot-repeater-nav griot-icon griot-icon-next next' ng-click='repeater.swipeNext()' ng-class=\"{'disabled':nextDisabled}\"></span></div><div class='griot-repeater-container swiper-container'><div class='griot-repeater-wrapper swiper-wrapper'><div class='griot-repeater-item swiper-slide' ng-repeat='elem in model."+t.name+"'><div class='griot-repeater-meta-wrap'><span class='griot-repeater-meta'>"+t.labelSingular+"&nbsp;&nbsp;{{$index + 1}}&nbsp;&nbsp;of&nbsp;&nbsp;{{repeater.slides.length}}</span><a class='griot-repeater-menu-toggle griot-icon griot-icon-menu' ng-click='toggleMenu()' ng-class='{active:showMenu}'></a><div class='griot-repeater-menu' ng-show='showMenu'><div class='griot-repeater-menu-option'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-delete' ng-click='remove(model."+t.name+", $index)'></a><a class='griot-repeater-menu-option-label' ng-click='remove(model."+t.name+", $index)'>Delete "+t.labelSingular+"</a></div><div class='griot-repeater-menu-option' ng-class='{disabled:$index === 0}'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-shiftleft' ng-click='rearrange(model."+t.name+", $index, $index - 1)'></a><a class='griot-repeater-menu-option-label' ng-click='rearrange(model."+t.name+", $index, $index - 1)'>Shift left</a></div><div class='griot-repeater-menu-option' ng-class='{disabled:$index === repeater.slides.length - 1}'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-shiftright' ng-click='rearrange(model."+t.name+", $index, $index + 1)'></a><a class='griot-repeater-menu-option-label' ng-click='rearrange(model."+t.name+", $index, $index + 1)'>Shift right</a></div></div></div><div class='griot-repeater-fields' ng-transclude></div></div></div></div></div></div>"},link:function(e,t,n){var i=this;e.register(n.name),e.build(t),e.refreshNav(),jQuery(window).on("click",function(n){var i=t.find(".griot-repeater-meta-wrap");jQuery(n.target).closest(".griot-repeater-meta-wrap").is(i)||e.$apply(e.showMenu=!1)}),e.$watchCollection(function(){return e.model[n.name]},function(){window.clearTimeout(i.checkModel),i.checkModel=window.setTimeout(function(){e.refresh()},10)})}}}]),angular.module("griot").directive("switch",["ModelChain",function(e){return{restrict:"E",replace:!0,controller:["$scope","$element","$attrs",function(t,n,i){t.model=e.getModel(t),t.model[i.name]=t.model[i.name]?t.model[i.name]:i.default,t.switchers=t.hasOwnProperty("switchers")?t.switchers:{},t.switchers[i.name]={"default":i.default,types:[]},this.registerType=function(e,n){-1===t.switchers[i.name].types.indexOf(e)&&t.switchers[i.name].types.push({name:e,label:n}),console.log("Registered "+e),console.log(t.switchers[i.name].types)},this.getSwitchName=function(){return i.name}}],template:function(e,t){var n=e.html(),i="<div class='griot-switch-wrap'><div class='griot-field-wrap'><div class='griot-field-meta'><span class='griot-label'>"+t.label+"</span><select ng-model='model[ \""+t.name+"\" ]' ng-options='type.name as type.label for type in switchers."+t.name+".types'></select></div></div>"+n+"</div>";return i},link:function(){}}}]),angular.module("griot").directive("switchgroup",["$compile","ModelChain",function(){return{restrict:"E",replace:!0,require:"^switch",controller:["$scope","$element","$attrs",function(e){e.isCurrentType=function(t){return t===e.model[e.switchName]}}],template:function(e,t){var n=e.html(),i="<div class='griot-switch-item' ng-show='isCurrentType(\""+t.type+"\")'>"+n+"</div>";return i},link:function(e,t,n,i){e.switchName=i.getSwitchName(),i.registerType(n.type,n.label)}}}]),angular.module("griot").directive("zoomer",["$http","ModelChain",function(e,t){return{restrict:"E",replace:!0,template:function(e,t){var n=e.html();t.hasAnnotations=n?!0:!1;var i="<div class='griot-annotated-image'><div class='griot-zoomer griot-prevent-swipe' id='zoomer"+Math.floor(1e6*Math.random())+"-{{$id}}' ng-class='{ hasAnnotations: hasAnnotations, noAnnotations: !hasAnnotations, isDroppable: isDroppable }' />";return n&&(i+="<repeater annotations label='"+t.annotationsLabel+"' name='"+t.annotationsName+"' label-singular='"+t.annotationsLabelSingular+"' label-plural='"+t.annotationsLabelPlural+"'>"+n+"</repeater>"),i+="</div>"},controller:["$scope","$element","$attrs","$timeout",function(t,n,i){var a=this;t.isDroppable=!1,t.checkForTiles=function(){var n=t.model[i.name];if(n!==t.imageID||"undefined"==typeof t.zoomer){if(!n)return void a.destroyZoomer(!0);t.tilejson=t.ui.tileServer+n+".tif";var o=e.get(t.tilejson);o.success(function(e){t.tileData=e,a.destroyZoomer(!0),a.setupZoomer(!0)}),o.error(function(){a.destroyZoomer(!0)})}},this.setupZoomer=function(e){"undefined"==typeof e&&(e=!1),t.imageID=t.model[i.name],t.tilesURL=t.tileData.tiles[0].replace("http://0","//0"),t.container_id=n.find(".griot-zoomer").first().attr("id"),e&&t.isVisible()&&t.buildZoomer()},t.buildZoomer=function(){t.imageLayers=L.featureGroup(),t.zoomer=Zoomer.zoom_image({container:t.container_id,tileURL:t.tilesURL,imageWidth:t.tileData.width,imageHeight:t.tileData.height}),t.zoomer.map._zoomAnimated=!1,t.zoomer.map.addLayer(t.imageLayers),a.loadImageAreas(),t.hasAnnotations&&(a.addDrawingControls(),a.watchForExternalDeletion())},this.destroyZoomer=t.destroyZoomer=function(e){"undefined"==typeof e&&(e=!1),t.zoomer&&(t.zoomer.map.remove(),delete t.zoomer,delete Zoomer.zoomers[t.container_id],e&&(n.find(".griot-zoomer").empty(),t.imageID=null,t.model.annotations=[]))},this.loadImageAreas=function(){angular.forEach(this.getAnnotations(),function(e){var n=e.geoJSON,i=L.GeoJSON.geometryToLayer(n.geometry);i.annotation=e,t.imageLayers.addLayer(i)})},this.addDrawingControls=function(){var e=new L.Control.Draw({draw:{circle:!1,polyline:!1,marker:!1,rectangle:{shapeOptions:{color:"#eee"}}},edit:{featureGroup:t.imageLayers}});t.zoomer.map.addControl(e)},this.watchForExternalDeletion=function(){t.$watchCollection(function(){return a.getAnnotations()},function(){"undefined"!=typeof t.zoomer&&angular.forEach(t.imageLayers._layers,function(e){-1===jQuery.inArray(e.annotation,a.getAnnotations())&&t.imageLayers.removeLayer(e)})})},this.getZoomer=function(){return t.zoomer?t.zoomer:null},this.getAnnotations=function(){return t.model[i.annotationsName]},t.zoomOut=function(){"undefined"!=typeof t.zoomer.map&&t.zoomer.map.centerImageAtExtents()},t.hasMap=function(){return t.zoomer?!0:!1},this.getScope=function(){return t},this.getImageLayers=function(){return t.imageLayers},t.isVisible=function(){var e=!0;return n.parents().each(function(t,n){$(n).hasClass("griot-repeater-item")&&!$(n).hasClass("swiper-slide-active")&&(e=!1)}),e}}],link:function(e,n,i){t.updateModel(e,i.name),e.hasAnnotations=i.hasAnnotations,e.imageID=e.model[i.name],e.checkForTiles(),n.find(".griot-zoomer").droppable({over:function(t,n){n.helper.data("image-id")!=e.model[i.name]&&e.isVisible()&&e.$apply(function(){e.isDroppable=!0})},out:function(){e.$apply(function(){e.isDroppable=!1})},drop:function(t,n){e.isVisible()&&n.helper.data("image-id")!=e.model[i.name]&&e.$apply(function(){e.isDroppable=!1,e.hasAnnotations&&e.model.annotations.length&&!confirm("This will destroy the "+e.model.annotations.length+" annotations attached to this view. Proceed?")||(e.model[i.name]=n.helper.data("image-id"),e.checkForTiles())})}}),n.find("select").on("change",function(){console.log("changed"),e.checkForTiles()}),e.$on("slidesReady",function(){e.isVisible()&&setTimeout(function(){"undefined"==typeof e.zoomer&&e.buildZoomer()},500)}),e.$on("slideChange",function(){"undefined"!=typeof e.zoomer&&e.destroyZoomer(!1),e.isVisible()&&"undefined"==typeof e.zoomer&&e.buildZoomer()})}}}]),L.extend(L.LatLngBounds.prototype,{toGeoJSON:function(){L.Polygon.prototype.toGeoJSON.call(this)},getLatLngs:function(){L.Polygon.prototype._convertLatLngs([[this.getSouthWest().lat,this.getSouthWest().lng],[this.getNorthWest().lat,this.getNorthWest().lng],[this.getNorthEast().lat,this.getNorthEast().lng],[this.getSouthEast().lat,this.getSouthEast().lng]])}}),angular.module("griot").filter("filterObjects",function(){return function(e,t,n){return t.zoomables?n?t.zoomables.objects[n]:t.zoomables.all:void console.log("WARNING: No config detected!")}}),angular.module("griot").filter("filterMediaByObject",["ModelChain",function(){return function(e,t,n){var i=[];return t?(angular.forEach(e,function(e){e.object_id==n&&i.push(e)}),i):e}}]),angular.module("griot").filter("getTitle",function(){return function(e){return""===e.post_title?"Untitled (post #"+e.ID+")":e.post_title}}),angular.module("griot").filter("parseInt",function(){return function(e){return parseInt(e)}}),angular.module("griot").factory("ModelChain",function(){return{initialize:function(e){e.modelChain=["data"],e.model=e.data},updateModel:function(e,t){e.modelChain=angular.copy(e.$parent.modelChain),"undefined"!=typeof e.$parent.$index&&e.modelChain.push(e.$parent.$index),e.model=e;for(var n=0;n<e.modelChain.length;n++)e.model=e.model[e.modelChain[n]];e.modelChain.push(t)},getModel:function(e){var t=angular.copy(e.$parent.modelChain);"undefined"!=typeof e.$index&&t.push(e.$index);for(var n=e,i=0;i<t.length;i++)n=n[t[i]];return n},bypassModel:function(e){e.modelChain=angular.copy(e.$parent.modelChain),"undefined"!=typeof e.$parent.$index&&e.modelChain.push(e.$parent.$index),e.model=e;for(var t=0;t<e.modelChain.length;t++)e.model=e.model[e.modelChain[t]]}}});