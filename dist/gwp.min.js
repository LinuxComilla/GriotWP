angular.module("griot",[]),jQuery(document).ready(function(){jQuery("body").addClass("griot-post").find("#poststuff").attr({"ng-app":"griot","ng-controller":"griotCtrl"}).find("#post-body-content").append("<div id='griot'><textarea name='content' id='griot-data'>{{ data | json }}</textarea><fieldset><field type='text' name='objectid' label='Object ID' /></fieldset><div media-drawer></div></div>").find("#title").attr({"ng-model":"data.title"}),angular.bootstrap(document,["griot"])}),jQuery(document).ready(function(){jQuery("input[name='griot_config_url']").on("change",function(e){if(!e.target.value)return void jQuery("#griot-config-url-response").fadeOut(200,function(){jQuery(this).removeClass("error success").html("")});jQuery("#griot-config-url-response").removeClass("success error").html("Fetching config ...").fadeIn(200);var t={action:"griot_get_config",config_url:e.target.value};jQuery.post(ajaxurl,t,function(e){if("error"===e)return void jQuery("#griot-config-url-response").removeClass("success").addClass("error").html("<strong>Error:</strong> The config cannot be read. It may be missing, inaccessible, or malformed.").fadeIn(200);var t=JSON.parse(e),a=0,i=0;for(var o in t)t.hasOwnProperty(o)&&(a++,i+=t[o].images.length);jQuery("#griot-config-url-response").removeClass("error").addClass("success").html("<strong>Success!</strong> Found <strong>"+a+"</strong> objects and <strong>"+i+"</strong> zoomable images.").fadeIn(200)})}),jQuery("#griot-image-source-setting-external").is(":checked")?jQuery("#griot-image-list-setting").closest("tr").show():jQuery("#griot-image-list-setting").closest("tr").hide(),jQuery("input[name='griot_image_source']").on("change",function(){jQuery("#griot-image-source-setting-external").is(":checked")?jQuery("#griot-image-list-setting").closest("tr").fadeIn(100):jQuery("#griot-image-list-setting").closest("tr").fadeOut(100)})}),angular.module("griot").controller("griotCtrl",["$scope","$http","ModelChain",function(e,t,a){a.initialize(e),e.data=griotData.data?JSON.parse(griotData.data):{},e.data.title=griotData.title,e.ui={recordType:griotData.recordType,oppositeRecordType:"object"==griotData.recordType?"story":"object",recordList:griotData.recordList,tileServer:griotData.tileServer,zoomables:griotData.config,media:[]};for(var i in e.ui.zoomables){var o=e.ui.zoomables[i];if(void 0==o.meta)return;for(var n=o.meta,r=o.images,s=0;s<r.length;s++){var l=r[s];l.object_id=i,l.id=l.file.split(/\.tif|\.jpg|\.png/)[0],l.thumb=r[s].thumb="http://tiles.dx.artsmia.org/"+l.id+"/0/0/0.png",l.meta=[n.artist,n.continent,n.country,n.creditline,n.culture,n.description,n.medium,n.title].join(" "),l.object_title=n.title,e.ui.media.push(l)}}}]),angular.module("griot").directive("annotations",["$timeout","$compile",function(e,t){return{restrict:"A",require:["repeater","^zoomer"],link:function(e,a,i,o){var n=this,r=o[0],s=o[1],l=s.getScope(),d=angular.element("<a class='griot-button' ng-show='hasMap()' ng-click='zoomOut()'>Zoom Out</a>"),c=t(d);a.find(".griot-button").first().replaceWith(d),c(l),e.$watch(function(){return r.getActiveIndex()},function(){var e=s.getZoomer(),t=s.getAnnotations();if(t[r.getActiveIndex()]){var a=t[r.getActiveIndex()].geoJSON,i=L.GeoJSON.geometryToLayer(a.geometry);e&&e.map.fitBounds(i)}}),e.$on("zoomerBuilt",function(){var t=s.getZoomer();angular.forEach(s.getImageLayers()._layers,function(e){e.on("click",function(e){if(!n.deleting){var t=e.target.annotation,a=jQuery.inArray(t,s.getAnnotations());r.swipeTo(a)}})}),t.map.on("draw:deletestart",function(){n.deleting=!0}),t.map.on("draw:deletestop",function(){n.deleting=!1}),t.map.on("draw:created",function(a){var i=a.layer.toGeoJSON();e.$apply(function(){var e=s.getAnnotations().push({geoJSON:i}),a=s.getAnnotations()[e-1],o=L.GeoJSON.geometryToLayer(i.geometry);o.annotation=a,s.getImageLayers().addLayer(o),t.map.fitBounds(o),o.on("click",function(e){if(!n.deleting){var t=e.target.annotation,a=jQuery.inArray(t,s.getAnnotations());r.swipeTo(a)}})})}),t.map.on("draw:deleted",function(t){var a=r.getRepeater(),i=r.getActiveIndex(),o=0,n=[],l=[];angular.forEach(t.layers._layers,function(e){var t=jQuery.inArray(e.annotation,s.getAnnotations());l.push(t)}),angular.forEach(s.getAnnotations(),function(e,t){-1===jQuery.inArray(t,l)&&n.push(t)}),l.reverse();for(var d=0;d===l.length&&0!==i;d++)i===l[d]&&i--;angular.forEach(n,function(e,t){i===e&&(o=t)}),angular.forEach(l,function(t){e.$apply(function(){s.getAnnotations().splice(t,1)})}),a.swipeTo(o,0,!1)}),t.map.on("draw:edited",function(t){angular.forEach(t.layers._layers,function(t){var a=t.toGeoJSON();e.$apply(function(){t.annotation.geoJSON=a})})})})}}}]),angular.module("griot").directive("ckEditor",function(){return{restrict:"A",require:["?^repeater","?ngModel"],link:function(e,t,a,i){var o=i[0],n=i[1],r=CKEDITOR.replace(t[0],{allowedContent:!0});o&&r.on("instanceReady",function(){o.refresh()}),r.on("pasteState",function(){e.$apply(function(){n.$setViewValue(r.getData())})}),n.$render=function(){r.setData(n.$viewValue)},a.hasOwnProperty("protected")&&r.on("instanceReady",function(){e.$watch("protected",function(e){r.setReadOnly(e)})})}}}),angular.module("griot").directive("field",function(){return{restrict:"E",replace:!0,scope:{data:"=",ui:"="},controller:["$scope","$element","$attrs","ModelChain",function(e,t,a,i){e.griotData=griotData,e.protected=a.hasOwnProperty("protected"),e.toggleProtection=function(){e.protected=!e.protected},a.hasOwnProperty("bypassmodel")?i.bypassModel(e):i.updateModel(e,a.name)}],template:function(e,t){var a;switch(t.type){case"objectselector":a="<objectselector name='"+t.name+"' />";break;case"text":a="<input type='text' ng-model='model."+t.name+"' ng-disabled='protected' />";break;case"textarea":a="<textarea ng-model='model."+t.name+"' ng-disabled='protected' ></textarea>";break;case"wysiwyg":a="<textarea ng-model='model."+t.name+"' ck-editor ng-disabled='protected' ></textarea>";break;case"zoomer":t.bypassmodel="bypassmodel";var i=e.html();a="<zoomer name='"+t.name+"' object='"+t.object+"' annotations-name='"+t.annotationsName+"' annotations-label='"+t.annotationsLabel+"' annotations-label-singular='"+t.annotationsLabelSingular+"' annotations-label-plural='"+t.annotationsLabelPlural+"'>"+i+"</zoomer>";break;case"relationship":a="<select ng-model='model."+t.name+"' ng-options='( record.ID | parseInt ) as ( record | getTitle ) for record in ui.recordList[ ui.oppositeRecordType ]' multiple ng-disabled='protected' ></select>";break;case"image":a="<imagepicker name='"+t.name+"' />";break;case"select":var o=[];$options=jQuery(e).find("option"),$options.each(function(e,t){o.push({value:jQuery(t).val(),label:jQuery(t).text(),selected:jQuery(t).prop("selected")})}),t.jsonFieldOptions=angular.toJson(o),a="<select ng-model='model."+t.name+"' ng-options='option.value as option.label for option in fieldOptions'></select>";break;case"checkbox":a="<input type='checkbox' ng-model='model."+t.name+"' />"}var n="<div class='griot-field-wrap' ng-class='{ \"griot-protected\": protected }' data='data' ui='ui' ng-hide='attrs.hidden'><div class='griot-field-meta'>";return t.hasOwnProperty("label")&&(n+="<span class='griot-label'>"+t.label+"</span>"),t.hasOwnProperty("protected")&&(n+="<a class='griot-button' ng-if='protected' ng-click='toggleProtection()'>Unlock</a><a class='griot-button' ng-if='!protected' ng-click='toggleProtection()'>Lock</a>"),n+="</div><div class='griot-field'>"+a+"</div></div>"},link:function(e,t,a){if("undefined"!=typeof a.autofill)try{e.model[a.name]=e.$eval(a.autofill)}catch(i){console.log("Autofill error on "+a.name+":"+i)}switch(a.type){case"select":e.fieldOptions=angular.fromJson(a.jsonFieldOptions),e.model[a.name]||angular.forEach(e.fieldOptions,function(t){t.selected&&(e.model[a.name]=t.value)})}}}}),angular.module("griot").directive("fieldset",function(){return{restrict:"E",replace:!0,templateUrl:function(){return griotData.templateUrl}}}),angular.module("griot").directive("griotRepeaterFields",["$timeout",function(e){return{restrict:"C",require:"^repeater",link:function(t,a,i,o){t.$last&&(o.refresh(),e(function(){o.stopInitializing()})),t.$watch(function(){return a.height()},function(e,t){e!=t&&o.refresh()}),a.find("input,textarea").last().on("keydown",function(e){return 9!==e.keyCode||e.shiftKey!==!1||repeater.nextDisabled()?9!==e.keyCode||e.shiftKey!==!0||repeater.prevDisabled()?void 0:(repeater.prevFocus(),!1):(repeater.nextFocus(),!1)})}}}]),angular.module("griot").directive("imagepicker",["$compile",function(e){return{restrict:"E",replace:!0,template:function(){var e="<div class='griot-imagepicker' >";return"external"===griotData.imageSrc&&(e+="<div class='griot-image-chooser' ng-class='{active: angframe.isOpen}'><img class='griot-image-thumbnail' ng-repeat='imageUrl in imageList' ng-src='{{ imageUrl }}' ng-click='angframe.select( imageUrl )' /></div>"),e+="<div class='griot-current-image' ng-class='{empty: !hasImage }' ng-style='{ backgroundImage: backgroundImage }' ng-click='openFrame()'></div></div>"},controller:["$scope","$element","$attrs",function(e,t,a){e.hasImage=e.model[a.name],e.backgroundImage=e.model[a.name]?"url("+e.model[a.name]+")":"auto",e.isImageTarget=!1,e.wpmframe=wp.media.griotImageLibrary.frame(),e.wpmframe.on("select",function(){if(e.isImageTarget){var t=e.wpmframe.state().get("selection");t.each(function(t){t.attributes.url&&e.$apply(function(){e.model[a.name]=t.attributes.url,e.backgroundImage="url("+t.attributes.url+")",e.isImageTarget=!1,e.hasImage=!0})})}}),e.imageList=griotData.imageList,e.angframe={isOpen:!1,select:function(t){t&&(e.model[a.name]=t,e.backgroundImage="url("+t+")",e.isImageTarget=!1,e.hasImage=!0),e.angframe.close()},open:function(){e.angframe.isOpen=!0},close:function(){e.angframe.isOpen=!1},toggle:function(){e.angframe.isOpen=!e.angframe.isOpen}},e.openFrame=function(){e.protected||("wordpress"===griotData.imageSrc?e.wpmframe.open():e.angframe.toggle(),e.isImageTarget=!0)},e.removeImage=function(){e.protected||(e.model[a.name]=null,e.hasImage=!1,e.backgroundImage="auto",e.angframe.close())}}],link:function(t,a){var i=angular.element("<a class='griot-button griot-pick-image' ng-disabled='protected' ng-click='openFrame()' ng-if='!hasImage'>Choose image</a><a class='griot-button griot-pick-image' ng-disabled='protected' ng-click='openFrame()' ng-if='hasImage'>Change image</a><a class='griot-button griot-remove-image' ng-disabled='protected' ng-if='hasImage' ng-click='removeImage()'>Remove image</a>"),o=e(i);a.closest(".griot-field-wrap").find(".griot-field-meta").append(i),o(t)}}}]),wp.media.griotImageLibrary={frame:function(){return this._frame?this._frame:(this._frame=wp.media({id:"griot-library-frame",title:"Insert an image",multiple:!1,editing:!0,library:{type:"image"},button:{text:"Insert"}}),this._frame)}},angular.module("griot").directive("mediaDrag",function(){return function(e,t){t.draggable({helper:"clone",scroll:!1,revert:"invalid",revertDuration:300})}}),angular.module("griot").directive("mediaDrawer",["$http","$rootScope",function(e,t){return{restrict:"A",replace:!0,template:"<div class='griot-media-drawer' ng-class=\"{'visible':$root.mediaVisible}\"><a class='griot-media-toggle' ng-click='toggle()'></a><div class='griot-media-controls'><h2 class='griot-media-header'>Available Media</h2><p class='griot-media-instructions'>Drag to the left panel to insert.</p><input class='griot-media-search' type='text' ng-model='mediaSearch.meta' id='griot-media-search' placeholder='Search media' /><input class='griot-media-filter-by-object' type='checkbox' ng-model='filterByObject' id='griot-media-filter-by-object' /><label class='griot-media-label' for='griot-media-filter-by-object'>Current object media only</label></div><div class='griot-media-window'><div class='griot-media-thumb' ng-repeat='image in ui.media | filterMediaByObject:filterByObject:data.id | filter:mediaSearch | limitTo:quantity' ><img class='griot-media-image' ng-src='{{image.thumb}}' data-object-id='{{image.object_id}}' data-image-id='{{image.id}}' data-object-title='{{image.object_title}}' data-image-approved='{{image.approved}}' media-drag /></div></div></div>",controller:["$scope","$element","$attrs",function(e){e.quantity=50,t.mediaVisible=!1,e.toggle=function(){t.mediaVisible=!t.mediaVisible}}],link:function(){}}}]),angular.module("griot").directive("objectselector",["ModelChain","$compile","$rootScope",function(e,t,a){return{restrict:"E",replace:!0,template:function(){var e="<div class='griot-object-selector' ng-class='{isDroppable: isDroppable}'><div class='griot-object-selector-data'><p ng-if='data.id'>{{ui.zoomables[data.id].meta.title}}</p><p ng-if='!data.id'>No object selected</p><table ng-if='data.id' border='0' cellpadding='0' cellspacing='0'><tr><td>Accession No.</td><td>{{ui.zoomables[data.id].meta.accession_number}}</td></tr><tr><td>Object ID</td><td>{{data.id}}</td></tr><tr><td>Artist</td><td>{{ui.zoomables[data.id].meta.artist}}</td></tr><tr><td>Dates</td><td>{{ui.zoomables[data.id].meta.dated}}</td></tr><tr><td>Location</td><td>{{ui.zoomables[data.id].meta.country}}, {{ui.zoomables[data.id].meta.continent}}</td></tr><tr><td>Medium</td><td>{{ui.zoomables[data.id].meta.medium}}</td></tr><tr><td>Thumbnail</td><td><img src='http://api.artsmia.org/images/{{data.id}}/small.jpg'></td></tr></table></div></div>";return e},controller:["$scope","$element","$attrs",function(e,t,i){e.data.id&&void 0==e.data.thumbnail&&(e.data.thumbnail="http://api.artsmia.org/images/"+e.data.id+"/large.jpg"),e.isDroppable=!1,e.isEmpty="undefined"==typeof e.model[i.name],e.backgroundImage=e.data.id?"url("+e.ui.zoomables[e.model[i.name]].images[0].thumb+")":"",e.openMediaDrawer=function(){a.mediaVisible=!0},e.updateThumb=function(t){e.backgroundImage="url("+t.attr("src")+")"},e.autoUpdateMeta=function(){var t,a,i,o,n,r,s,l,d;t=e.ui.zoomables[e.data.id].meta.artist||"Artist unknown",a=e.ui.zoomables[e.data.id].meta.culture||"",i=e.ui.zoomables[e.data.id].meta.country||"",o=e.ui.zoomables[e.data.id].meta.dated||"",n=e.ui.zoomables[e.data.id].meta.medium||"",r=e.ui.zoomables[e.data.id].meta.dimension||"",s=e.ui.zoomables[e.data.id].meta.creditline||"",l=e.ui.zoomables[e.data.id].meta.accession_number||"",d=e.ui.zoomables[e.data.id].meta.description,e.data.meta1=t+", "+(a&&a+", ")+i,e.data.meta2=o,e.data.meta3=(n&&n+"\n")+(r&&r+"\n")+(s&&s+"\n")+l,e.data.thumbnail="http://api.artsmia.org/images/"+e.data.id+"/large.jpg"},e.removeObject=function(){e.data.id=null,(e.data.meta1||e.data.meta2||e.data.meta3)&&confirm("Would you like to clear the meta fields as well?")&&(e.data.meta1=e.data.meta2=e.data.meta3=null)}}],link:function(e,a,i){var o=angular.element("<a class='griot-button griot-pick-object' ng-disabled='protected' ng-click='openMediaDrawer()' ng-if='!data.id'>Choose object</a><a class='griot-button griot-pick-object' ng-disabled='protected' ng-click='openMediaDrawer()' ng-if='data.id'>Change object</a><a class='griot-button griot-remove-object' ng-disabled='protected' ng-if='data.id' ng-click='removeObject()'>Remove object</a>"),n=t(o);a.closest(".griot-field-wrap").find(".griot-field-meta").append(o),n(e),jQuery(a).droppable({tolerance:"touch",over:function(){e.$apply(function(){e.isDroppable=!0})},out:function(){e.$apply(function(){e.isDroppable=!1})},drop:function(t,a){e.$apply(function(){e.data.id;e.isDroppable=!1,e.model[i.name]=a.helper.data("object-id").toString(),e.updateThumb(a.helper)})}})}}}]),angular.module("griot").directive("repeater",["$timeout",function(){return{restrict:"E",replace:!0,scope:{data:"=",ui:"="},transclude:!0,controller:["$scope","$element","$attrs","$timeout","ModelChain",function(e,t,a,i,o){o.updateModel(e,a.name),e.showMenu=!1,e.prevDisabled=!0,e.nextDisabled=!0,e.initializing=!0,e.register=function(t){e.model.hasOwnProperty(t)||(e.model[t]=[])},e.build=function(t){var a=t.find(".swiper-container").first().swiper({calculateHeight:!0,pagination:t.find(".griot-repeater-pagination").first()[0],paginationClickable:!0,paginationElementClass:"griot-repeater-bullet",paginationActiveClass:"active",onSlideChangeStart:function(){e.refreshNav()},onSlideChangeEnd:function(){e.$broadcast("slideChange")},onInit:function(){e.$broadcast("slidesReady")},noSwiping:!0,noSwipingClass:"griot-prevent-swipe"});e.repeater=a},e.refreshNav=function(){i(0===e.repeater.activeIndex?function(){e.prevDisabled=!0}:function(){e.prevDisabled=!1}),i(e.repeater.activeIndex===e.repeater.slides.length-1?function(){e.nextDisabled=!0}:function(){e.nextDisabled=!1})},e.refresh=function(){i(function(){var t=e.repeater.slides.length;e.repeater.reInit();var a=e.repeater.slides.length;e.repeater.swipeTo(a>t&&!e.initializing?a-1:e.repeater.activeIndex),e.refreshNav()})},e.add=function(t){e.showMenu=!1,t.push({})},e.remove=function(t,a){e.showMenu=!1,t.splice(a,1)},e.rearrange=function(t,a,o){t.splice(o,0,t.splice(a,1)[0]),i(function(){e.repeater.swipeTo(o)})},e.toggleMenu=function(){e.showMenu=!e.showMenu},e.swipeToActive=function(){i(function(){e.repeater.swipeTo(e.repeater.activeIndex)})},this.refresh=function(){e.refresh()},this.add=function(t){e.add(t)},this.nextFocus=function(){e.nextDisabled||(e.repeater.swipeNext(),setTimeout(function(){jQuery(e.repeater.slides[e.repeater.activeIndex]).find("input,textarea").first().focus()},e.repeater.params.speed+10))},this.prevFocus=function(){e.prevDisabled||(e.repeater.swipePrev(),setTimeout(function(){jQuery(e.repeater.slides[e.repeater.activeIndex]).find("input,textarea").last().focus()},e.repeater.params.speed+10))},this.nextDisabled=function(){return e.nextDisabled},this.prevDisabled=function(){return e.prevDisabled},this.getActiveIndex=function(){return e.repeater.activeIndex},this.getRepeater=function(){return e.repeater},this.swipeTo=function(t){i(function(){e.repeater.swipeTo(t)})},this.stopInitializing=function(){e.initializing=!1}}],template:function(e,t){return"<div class='griot-field-wrap' data='data' ui='ui'><p class='griot-field-meta'><span class='griot-label'>"+t.label+"</span> <a class='griot-button' ng-click='add( model."+t.name+', "'+t.name+"\" )' >Add "+t.labelSingular+"</a></p><div class='griot-repeater'><div class='griot-repeater-header' ng-show='repeater.slides.length !== 0'><div class='griot-repeater-pagination'></div><span class='griot-repeater-nav griot-icon griot-icon-prev prev' ng-click='repeater.swipePrev()' ng-class=\"{'disabled':prevDisabled}\"></span><span class='griot-repeater-nav griot-icon griot-icon-next next' ng-click='repeater.swipeNext()' ng-class=\"{'disabled':nextDisabled}\"></span></div><div class='griot-repeater-container swiper-container'><div class='griot-repeater-wrapper swiper-wrapper'><div class='griot-repeater-item swiper-slide' ng-repeat='elem in model."+t.name+"'><div class='griot-repeater-meta-wrap'><span class='griot-repeater-meta'>"+t.labelSingular+"&nbsp;&nbsp;{{$index + 1}}&nbsp;&nbsp;of&nbsp;&nbsp;{{repeater.slides.length}}</span><a class='griot-repeater-menu-toggle griot-icon griot-icon-menu' ng-click='toggleMenu()' ng-class='{active:showMenu}'></a><div class='griot-repeater-menu' ng-show='showMenu'><div class='griot-repeater-menu-option'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-delete' ng-click='remove(model."+t.name+", $index)'></a><a class='griot-repeater-menu-option-label' ng-click='remove(model."+t.name+", $index)'>Delete "+t.labelSingular+"</a></div><div class='griot-repeater-menu-option' ng-class='{disabled:$index === 0}'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-shiftleft' ng-click='rearrange(model."+t.name+", $index, $index - 1)'></a><a class='griot-repeater-menu-option-label' ng-click='rearrange(model."+t.name+", $index, $index - 1)'>Shift left</a></div><div class='griot-repeater-menu-option' ng-class='{disabled:$index === repeater.slides.length - 1}'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-shiftright' ng-click='rearrange(model."+t.name+", $index, $index + 1)'></a><a class='griot-repeater-menu-option-label' ng-click='rearrange(model."+t.name+", $index, $index + 1)'>Shift right</a></div></div></div><div class='griot-repeater-fields' ng-transclude></div></div></div></div></div></div>"},link:function(e,t,a){var i=this;e.register(a.name),e.build(t),e.refreshNav(),jQuery(window).on("click",function(a){var i=t.find(".griot-repeater-meta-wrap");jQuery(a.target).closest(".griot-repeater-meta-wrap").is(i)||e.$apply(e.showMenu=!1)}),e.$watchCollection(function(){return e.model[a.name]},function(){window.clearTimeout(i.checkModel),i.checkModel=window.setTimeout(function(){e.refresh()},10)})}}}]),angular.module("griot").directive("switch",["ModelChain",function(e){return{restrict:"E",replace:!0,controller:["$scope","$element","$attrs",function(t,a,i){t.model=e.getModel(t),t.model[i.name]=t.model[i.name]?t.model[i.name]:i.default,t.switchers=t.hasOwnProperty("switchers")?t.switchers:{},t.switchers[i.name]={"default":i.default,types:[]},this.registerType=function(e,a){-1===t.switchers[i.name].types.indexOf(e)&&t.switchers[i.name].types.push({name:e,label:a}),console.log("Registered "+e),console.log(t.switchers[i.name].types)},this.getSwitchName=function(){return i.name}}],template:function(e,t){var a=e.html(),i="<div class='griot-switch-wrap'><div class='griot-field-wrap'><div class='griot-field-meta'><span class='griot-label'>"+t.label+"</span><select ng-model='model[ \""+t.name+"\" ]' ng-options='type.name as type.label for type in switchers."+t.name+".types'></select></div></div>"+a+"</div>";return i},link:function(){}}}]),angular.module("griot").directive("switchgroup",["$compile","ModelChain",function(){return{restrict:"E",replace:!0,require:"^switch",controller:["$scope","$element","$attrs",function(e){e.isCurrentType=function(t){return t===e.model[e.switchName]}}],template:function(e,t){var a=e.html(),i="<div class='griot-switch-item' ng-show='isCurrentType(\""+t.type+"\")'>"+a+"</div>";return i},link:function(e,t,a,i){e.switchName=i.getSwitchName(),i.registerType(a.type,a.label)}}}]),angular.module("griot").directive("trackMedia",function(){return function(e,t){var a=jQuery(t);a.on("change",function(){var e={action:"griot_track_media",track_id:griotData.postID,track_status:a.prop("checked")?"track":"untrack",_wpnonce:griotData.trackMediaNonce};jQuery.post(ajaxurl,e,function(e){return"error"===e?void alert("Sorry, this feature isn't working at the moment. Please try again soon."):void jQuery(".griot-track-media-saved").show().delay(1500).fadeOut(500)})})}}),angular.module("griot").directive("zoomer",["$http","ModelChain",function(e,t){return{restrict:"E",replace:!0,template:function(e,t){var a=e.html();t.hasAnnotations=a?!0:!1;var i="<div class='griot-annotated-image'><div class='griot-zoomer griot-prevent-swipe' id='zoomer"+Math.floor(1e6*Math.random())+"-{{$id}}' ng-class='{ hasAnnotations: hasAnnotations, noAnnotations: !hasAnnotations, isDroppable: isDroppable }'><p ng-if='!imageID' class='griot-zoomer-notice'>No image selected</p></div><p class='griot-zoomer-status griot-zoomer-status-final' ng-if='imageID && imageApproved'><span class='griot-zoomer-status-label'>Final</span> This image has been approved by Visual Resources.</p><p class='griot-zoomer-status griot-zoomer-status-fpo' ng-if='imageID && !imageApproved'><span class='griot-zoomer-status-label'>Temporary</span> This image may be used as a placeholder, but is likely to change.</p>";return a&&(i+="<repeater annotations label='"+t.annotationsLabel+"' name='"+t.annotationsName+"' label-singular='"+t.annotationsLabelSingular+"' label-plural='"+t.annotationsLabelPlural+"'>"+a+"</repeater>"),i+="</div>"},controller:["$scope","$element","$attrs","$timeout",function(t,a,i){var o=this;t.isDroppable=!1,t.checkForTiles=function(){var a=t.model[i.name];if(a!==t.imageID||"undefined"==typeof t.zoomer){if(!a)return void o.destroyZoomer(!0);t.tilejson=t.ui.tileServer+a+".tif";var n=e.get(t.tilejson);n.success(function(e){t.tileData=e,o.destroyZoomer(!0),o.setupZoomer()}),n.error(function(){o.destroyZoomer(!0)})}},this.setupZoomer=function(){t.imageID=t.model[i.name],t.imageApproved=!1;for(var e,o=0;o<t.ui.media.length;o++)if(e=t.ui.media[o],e.id===t.imageID){t.imageApproved=e.approved;break}t.tilesURL=t.tileData.tiles[0],t.container_id=a.find(".griot-zoomer").first().attr("id"),t.isVisible()&&t.buildZoomer()},t.buildZoomer=function(){t.imageLayers=L.featureGroup(),t.zoomer=Zoomer.zoom_image({container:t.container_id,tileURL:t.tilesURL,imageWidth:t.tileData.width,imageHeight:t.tileData.height}),t.zoomer.map._zoomAnimated=!1,t.zoomer.map.addLayer(t.imageLayers),o.loadImageAreas(),t.hasAnnotations&&(t.imageApproved&&o.addDrawingControls(),o.watchForExternalDeletion(),t.$broadcast("zoomerBuilt"))},this.destroyZoomer=t.destroyZoomer=function(e){"undefined"==typeof e&&(e=!1),t.zoomer&&(t.zoomer.map.remove(),delete t.zoomer,delete Zoomer.zoomers[t.container_id],e&&(a.find(".griot-zoomer").empty(),t.imageID=null,t.model.annotations=[]))},this.loadImageAreas=function(){angular.forEach(this.getAnnotations(),function(e){var a=e.geoJSON,i=L.GeoJSON.geometryToLayer(a.geometry);i.annotation=e,t.imageLayers.addLayer(i)})},this.addDrawingControls=function(){var e=new L.Control.Draw({draw:{circle:!1,polyline:!1,marker:!1,rectangle:{shapeOptions:{color:"#eee"}}},edit:{featureGroup:t.imageLayers}});t.zoomer.map.addControl(e)},this.watchForExternalDeletion=function(){t.$watchCollection(function(){return o.getAnnotations()},function(){"undefined"!=typeof t.zoomer&&angular.forEach(t.imageLayers._layers,function(e){-1===jQuery.inArray(e.annotation,o.getAnnotations())&&t.imageLayers.removeLayer(e)})})},this.getZoomer=function(){return t.zoomer?t.zoomer:null},this.getZoomerContainer=function(){return t.hasOwnProperty("zoomer")?t.zoomer.containerName:null},this.getAnnotations=function(){return t.model[i.annotationsName]},t.zoomOut=function(){"undefined"!=typeof t.zoomer.map&&t.zoomer.map.centerImageAtExtents()},t.hasMap=function(){return t.zoomer?!0:!1},this.getScope=function(){return t},this.getImageLayers=function(){return t.imageLayers},t.isVisible=function(){var e=!0;return a.parents().each(function(t,a){$(a).hasClass("griot-repeater-item")&&!$(a).hasClass("swiper-slide-active")&&(e=!1)}),e}}],link:function(e,a,i){t.updateModel(e,i.name),e.hasAnnotations=i.hasAnnotations,e.imageID=e.model[i.name],e.checkForTiles(),a.find(".griot-zoomer").droppable({over:function(t,a){a.helper.data("image-id")!=e.model[i.name]&&e.isVisible()&&e.$apply(function(){e.isDroppable=!0})},out:function(){e.$apply(function(){e.isDroppable=!1})},drop:function(t,a){e.isVisible()&&a.helper.data("image-id")!=e.model[i.name]&&e.$apply(function(){e.isDroppable=!1,e.hasAnnotations&&e.model.annotations.length&&!confirm("This will destroy the "+e.model.annotations.length+" annotations attached to this view. Proceed?")||(e.model[i.name]=a.helper.data("image-id"),e.checkForTiles())})}}),e.$on("slidesReady",function(){e.isVisible()&&setTimeout(function(){"undefined"==typeof e.zoomer&&e.buildZoomer()},500)}),e.$on("slideChange",function(){"undefined"!=typeof e.zoomer&&e.destroyZoomer(!1),e.isVisible()&&"undefined"==typeof e.zoomer&&e.buildZoomer()})}}}]),L.extend(L.LatLngBounds.prototype,{toGeoJSON:function(){L.Polygon.prototype.toGeoJSON.call(this)},getLatLngs:function(){L.Polygon.prototype._convertLatLngs([[this.getSouthWest().lat,this.getSouthWest().lng],[this.getNorthWest().lat,this.getNorthWest().lng],[this.getNorthEast().lat,this.getNorthEast().lng],[this.getSouthEast().lat,this.getSouthEast().lng]])}}),angular.module("griot").filter("filterObjects",function(){return function(e,t,a){return t.zoomables?a?t.zoomables.objects[a]:t.zoomables.all:void console.log("WARNING: No config detected!")}}),angular.module("griot").filter("filterMediaByObject",["ModelChain",function(){return function(e,t,a){var i=[];return t?(angular.forEach(e,function(e){e.object_id==a&&i.push(e)}),i):e}}]),angular.module("griot").filter("getTitle",function(){return function(e){return""===e.post_title?"Untitled (post #"+e.ID+")":e.post_title}}),angular.module("griot").filter("parseInt",function(){return function(e){return parseInt(e)}}),angular.module("griot").factory("ModelChain",function(){return{initialize:function(e){e.modelChain=["data"],e.model=e.data},updateModel:function(e,t){e.modelChain=angular.copy(e.$parent.modelChain),"undefined"!=typeof e.$parent.$index&&e.modelChain.push(e.$parent.$index),e.model=e;for(var a=0;a<e.modelChain.length;a++)e.model=e.model[e.modelChain[a]];e.modelChain.push(t)},getModel:function(e){var t=angular.copy(e.$parent.modelChain);"undefined"!=typeof e.$index&&t.push(e.$index);for(var a=e,i=0;i<t.length;i++)a=a[t[i]];return a},bypassModel:function(e){e.modelChain=angular.copy(e.$parent.modelChain),"undefined"!=typeof e.$parent.$index&&e.modelChain.push(e.$parent.$index),e.model=e;for(var t=0;t<e.modelChain.length;t++)e.model=e.model[e.modelChain[t]]}}});