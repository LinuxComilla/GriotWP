angular.module("griot",[]),jQuery(document).ready(function(){jQuery("#poststuff").attr({"ng-app":"griot","ng-controller":"griotCtrl"}).find("#post-body-content").append("<div id='griot'><textarea name='content' id='griot-data'>{{ data | json }}</textarea><fieldset><field type='text' name='objectid' label='Object ID' /></fieldset><div media-drawer></div></div>").find("#title").attr({"ng-model":"data.title"}),angular.bootstrap(document,["griot"])}),jQuery(document).ready(function(){jQuery("input[name='griot_tile_server']").on("change",function(e){if(!e.target.value)return void jQuery("#griot-tile-server-response").fadeOut(200,function(){jQuery(this).removeClass("error success").html("")});jQuery("#griot-tile-server-response").removeClass("success error").html("Fetching config ...").fadeIn(200);var t={action:"griot_get_config",config_url:e.target.value};jQuery.post(ajaxurl,t,function(e){if("error"===e)return void jQuery("#griot-tile-server-response").removeClass("success").addClass("error").html("<strong>Error:</strong> The tile server config cannot be read. It may be missing, inaccessible, or malformed.").fadeIn(200);var t=JSON.parse(e),i=0,n=0;console.log(t);for(var a in t.objects)!isNaN(parseFloat(a))&&isFinite(a)&&i++;n=t.all.length,jQuery("#griot-tile-server-response").removeClass("error").addClass("success").html("<strong>Success!</strong> Found <strong>"+i+"</strong> objects and <strong>"+n+"</strong> zoomable images.").fadeIn(200)})}),jQuery("#griot-image-source-setting-external").is(":checked")?jQuery("#griot-image-list-setting").closest("tr").show():jQuery("#griot-image-list-setting").closest("tr").hide(),jQuery("input[name='griot_image_source']").on("change",function(){jQuery("#griot-image-source-setting-external").is(":checked")?jQuery("#griot-image-list-setting").closest("tr").fadeIn(100):jQuery("#griot-image-list-setting").closest("tr").fadeOut(100)})}),angular.module("griot").controller("griotCtrl",["$scope","$http","ModelChain",function(e,t,i){if(i.initialize(e),e.data=griotData.data?JSON.parse(griotData.data):{},e.data.title=griotData.title,e.ui={recordType:griotData.recordType,oppositeRecordType:"object"==griotData.recordType?"story":"object",recordList:griotData.recordList,tileServer:griotData.tileServer,zoomables:griotData.config,objects:[]},griotData.config)for(var n in griotData.config.objects)"null"!==n&&"_empty_"!==n&&e.ui.objects.push(n);else console.log("WARNING: No config detected!")}]),angular.module("griot").directive("annotations",["$timeout","$compile",function(e,t){return{restrict:"A",require:["repeater","^zoomer"],link:function(e,i,n,a){var o=this,r=a[0],s=a[1],l=s.getScope(),c=angular.element("<a class='griot-button' ng-show='hasMap()' ng-click='zoomOut()'>Zoom Out</a>"),d=t(c);i.find(".griot-button").first().replaceWith(c),d(l),e.$watch(function(){return r.getActiveIndex()},function(){var e=s.getZoomer(),t=s.getAnnotations();if(t[r.getActiveIndex()]){var i=t[r.getActiveIndex()].geoJSON,n=L.GeoJSON.geometryToLayer(i.geometry);e&&e.map.fitBounds(n)}}),e.$watch(function(){return s.getZoomer()},function(t){t&&(angular.forEach(s.getImageLayers()._layers,function(e){e.on("click",function(e){if(!o.deleting){var t=e.target.annotation,i=jQuery.inArray(t,s.getAnnotations());r.swipeTo(i)}})}),t.map.on("draw:deletestart",function(){o.deleting=!0}),t.map.on("draw:deletestop",function(){o.deleting=!1}),t.map.on("draw:created",function(i){var n=i.layer.toGeoJSON();e.$apply(function(){var e=s.getAnnotations().push({geoJSON:n}),i=s.getAnnotations()[e-1],a=L.GeoJSON.geometryToLayer(n.geometry);a.annotation=i,s.getImageLayers().addLayer(a),t.map.fitBounds(a),a.on("click",function(e){if(!o.deleting){var t=e.target.annotation,i=jQuery.inArray(t,s.getAnnotations());r.swipeTo(i)}})})}),t.map.on("draw:deleted",function(t){var i=r.getRepeater(),n=r.getActiveIndex(),a=0,o=[],l=[];angular.forEach(t.layers._layers,function(e){var t=jQuery.inArray(e.annotation,s.getAnnotations());l.push(t)}),angular.forEach(s.getAnnotations(),function(e,t){-1===jQuery.inArray(t,l)&&o.push(t)}),l.reverse();for(var c=0;c===l.length&&0!==n;c++)n===l[c]&&n--;angular.forEach(o,function(e,t){n===e&&(a=t)}),angular.forEach(l,function(t){e.$apply(function(){s.getAnnotations().splice(t,1)})}),i.swipeTo(a,0,!1)}),t.map.on("draw:edited",function(t){angular.forEach(t.layers._layers,function(t){var i=t.toGeoJSON();e.$apply(function(){t.annotation.geoJSON=i})})}))})}}}]),angular.module("griot").directive("ckEditor",function(){return{restrict:"A",require:["?^repeater","?ngModel"],link:function(e,t,i,n){var a=n[0],o=n[1],r=CKEDITOR.replace(t[0],{allowedContent:!0});a&&r.on("instanceReady",function(){a.refresh()}),r.on("pasteState",function(){e.$apply(function(){o.$setViewValue(r.getData())})}),o.$render=function(){r.setData(o.$viewValue)},i.hasOwnProperty("protected")&&r.on("instanceReady",function(){e.$watch("protected",function(e){r.setReadOnly(e)})})}}}),angular.module("griot").directive("field",function(){return{restrict:"E",replace:!0,scope:{data:"=",ui:"="},controller:["$scope","$element","$attrs","ModelChain",function(e,t,i,n){e.griotData=griotData,e.protected=!1,e.toggleProtection=function(){e.protected=!e.protected},i.hasOwnProperty("bypassmodel")?n.bypassModel(e):n.updateModel(e,i.name)}],template:function(e,t){var i;switch(t.type){case"objectselector":t.bypassmodel="bypassmodel",i="<objectselector name='"+t.name+"' />";break;case"text":i="<input type='text' ng-model='model."+t.name+"' ng-disabled='protected' />";break;case"textarea":i="<textarea ng-model='model."+t.name+"' ng-disabled='protected' ></textarea>";break;case"wysiwyg":i="<textarea ng-model='model."+t.name+"' ck-editor ng-disabled='protected' ></textarea>";break;case"zoomer":t.bypassmodel="bypassmodel";var n=e.html();i="<zoomer name='"+t.name+"' object='"+t.object+"' annotations-name='"+t.annotationsName+"' annotations-label='"+t.annotationsLabel+"' annotations-label-singular='"+t.annotationsLabelSingular+"' annotations-label-plural='"+t.annotationsLabelPlural+"'>"+n+"</zoomer>";break;case"relationship":i="<select ng-model='model."+t.name+"' ng-options='( record.ID | parseInt ) as ( record | getTitle ) for record in ui.recordList[ ui.oppositeRecordType ]' multiple ng-disabled='protected' ></select>";break;case"image":i="<imagepicker name='"+t.name+"' />";break;case"select":var a=[];$options=jQuery(e).find("option"),$options.each(function(e,t){a.push({value:jQuery(t).val(),label:jQuery(t).text(),selected:jQuery(t).prop("selected")})}),t.jsonFieldOptions=angular.toJson(a),i="<select ng-model='model."+t.name+"' ng-options='option.value as option.label for option in fieldOptions'></select>";break;case"checkbox":i="<input type='checkbox' ng-model='model."+t.name+"' />"}var o="<div class='griot-field-wrap' ng-class='{ \"griot-protected\": protected }' data='data' ui='ui' ng-hide='attrs.hidden'><div class='griot-field-meta'>";return t.hasOwnProperty("label")&&(o+="<span class='griot-label'>"+t.label+"</span>"),t.hasOwnProperty("protected")&&(o+="<a class='griot-button' ng-if='protected' ng-click='toggleProtection()'>Unlock</a><a class='griot-button' ng-if='!protected' ng-click='toggleProtection()'>Lock</a>"),o+="</div><div class='griot-field'>"+i+"</div></div>"},link:function(e,t,i){if("undefined"!=typeof i.autofill)try{e.model[i.name]=e.$eval(i.autofill)}catch(n){console.log("Autofill error on "+i.name+":"+n)}switch(i.type){case"select":e.fieldOptions=angular.fromJson(i.jsonFieldOptions),e.model[i.name]||angular.forEach(e.fieldOptions,function(t){t.selected&&(e.model[i.name]=t.value)})}}}}),angular.module("griot").directive("fieldset",function(){return{restrict:"E",replace:!0,templateUrl:function(){return griotData.templateUrl}}}),angular.module("griot").directive("griotRepeaterFields",["$timeout",function(e){return{restrict:"C",require:"^repeater",link:function(t,i,n,a){t.$last&&(a.refresh(),e(function(){a.stopInitializing()})),t.$watch(function(){return i.height()},function(e,t){e!=t&&a.refresh()}),i.find("input,textarea").last().on("keydown",function(e){return 9!==e.keyCode||e.shiftKey!==!1||repeater.nextDisabled()?9!==e.keyCode||e.shiftKey!==!0||repeater.prevDisabled()?void 0:(repeater.prevFocus(),!1):(repeater.nextFocus(),!1)})}}}]),angular.module("griot").directive("imagepicker",["$compile",function(e){return{restrict:"E",replace:!0,template:function(){var e="<div class='griot-imagepicker' >";return"external"===griotData.imageSrc&&(e+="<div class='griot-image-chooser' ng-class='{active: angframe.isOpen}'><img class='griot-image-thumbnail' ng-repeat='imageUrl in imageList' ng-src='{{ imageUrl }}' ng-click='angframe.select( imageUrl )' /></div>"),e+="<div class='griot-current-image' ng-class='{empty: !hasImage }' ng-style='{ backgroundImage: backgroundImage }' ng-click='openFrame()'></div></div>"},controller:["$scope","$element","$attrs",function(e,t,i){e.hasImage=e.model[i.name],e.backgroundImage=e.model[i.name]?"url("+e.model[i.name]+")":"auto",e.isImageTarget=!1,e.wpmframe=wp.media.griotImageLibrary.frame(),e.wpmframe.on("select",function(){if(e.isImageTarget){var t=e.wpmframe.state().get("selection");t.each(function(t){t.attributes.url&&e.$apply(function(){e.model[i.name]=t.attributes.url,e.backgroundImage="url("+t.attributes.url+")",e.isImageTarget=!1,e.hasImage=!0})})}}),e.imageList=griotData.imageList,e.angframe={isOpen:!1,select:function(t){t&&(e.model[i.name]=t,e.backgroundImage="url("+t+")",e.isImageTarget=!1,e.hasImage=!0),e.angframe.close()},open:function(){e.angframe.isOpen=!0},close:function(){e.angframe.isOpen=!1},toggle:function(){e.angframe.isOpen=!e.angframe.isOpen}},e.openFrame=function(){e.protected||("wordpress"===griotData.imageSrc?e.wpmframe.open():e.angframe.toggle(),e.isImageTarget=!0)},e.removeImage=function(){e.protected||(e.model[i.name]=null,e.hasImage=!1,e.backgroundImage="auto",e.angframe.close())}}],link:function(t,i){var n=angular.element("<a class='griot-button griot-pick-image' ng-disabled='protected' ng-click='openFrame()' ng-if='!hasImage'>Choose image</a><a class='griot-button griot-pick-image' ng-disabled='protected' ng-click='openFrame()' ng-if='hasImage'>Change image</a><a class='griot-button griot-remove-image' ng-disabled='protected' ng-if='hasImage' ng-click='removeImage()'>Remove image</a>"),a=e(n);i.closest(".griot-field-wrap").find(".griot-field-meta").append(n),a(t)}}}]),wp.media.griotImageLibrary={frame:function(){return this._frame?this._frame:(this._frame=wp.media({id:"griot-library-frame",title:"Insert an image",multiple:!1,editing:!0,library:{type:"image"},button:{text:"Insert"}}),this._frame)}},angular.module("griot").directive("mediaDrag",function(){return function(e,t){t.draggable({helper:"clone",scroll:!1,revert:"invalid",revertDuration:300})}}),angular.module("griot").directive("mediaDrawer",["$http",function(e){return{restrict:"A",replace:!0,template:"<div class='griot-media-drawer' ng-class=\"{'visible':drawerVisible}\" ng-click=''><div class='griot-media-controls'><h2 class='griot-media-header'>Available Media</h2><p class='griot-media-instructions'>Drag to the left panel to insert.</p><input class='griot-media-search' type='text' ng-model='mediaSearch.meta' id='griot-media-search' placeholder='Search media' /><input class='griot-media-filter-by-object' type='checkbox' ng-model='filterByObject' id='griot-media-filter-by-object' /><label class='griot-media-label' for='griot-media-filter-by-object'>Current object media only</label></div><div class='griot-media-window'><div class='griot-media-thumb' ng-repeat='image in media | filterMediaByObject:filterByObject:data.id | filter:mediaSearch | limitTo:20' ><img class='griot-media-image' ng-src='{{image.thumb}}' data-object-id='{{image.object_id}}' data-image-id='{{image.id}}' data-object-title='{{image.object_title}}' media-drag /></div></div></div>",controller:["$scope","$element","$attrs",function(t){var i;t.drawerVisible=!0,t.media=[],t.logStart=function(){console.log("start")},e.get("http://author.loc/wp-content/plugins/GriotWP/tdx_rev.json").success(function(e){i=e}).then(function(){for(var e in i)for(var n=i[e].images,a=i[e].meta,o=0;o<n.length;o++){var r=n[o];r.object_id=e,r.id=r.file.split(".tif")[0],r.thumb="http://tiles.dx.artsmia.org/v2/"+r.file.split(".tif")[0]+"/0/0/0.png",r.meta=[a.artist,a.continent,a.country,a.creditline,a.culture,a.description,a.medium,a.title].join(" "),r.object_title=a.title,t.media.push(r)}})}],link:function(){}}}]),angular.module("griot").directive("objectselector",["ModelChain",function(e){return{restrict:"E",replace:!0,template:function(){var e="<div class='griot-object-selector'><div class='griot-object-selector-thumb' ng-class='{empty: isEmpty, isDroppable: isDroppable}' ng-style='{ backgroundImage: backgroundImage }'></div><h3 class='griot-object-selector-title'>{{objectTitle}}</h3></div>";return e},controller:["$scope","$element","$attrs",function(e,t,i){e.isDroppable=!1,e.isEmpty="undefined"==typeof e.model[i.name],e.objectTitle="",e.updateView=function(t){e.objectTitle=t.data("object-title"),e.backgroundImage="url("+t.attr("src")+")",e.isEmpty=!1}}],link:function(t,i,n){e.updateModel(t,n.name),i.find(".griot-object-selector-thumb").droppable({over:function(e,i){i.helper.data("object-id")!=t.model[n.name]&&t.$apply(function(){t.isDroppable=!0})},out:function(){t.$apply(function(){t.isDroppable=!1})},drop:function(e,i){t.$apply(function(){t.isDroppable=!1,t.model[n.name]=i.helper.data("object-id").toString(),t.updateView(i.helper)})}})}}}]),angular.module("griot").directive("repeater",["$timeout",function(){return{restrict:"E",replace:!0,scope:{data:"=",ui:"="},transclude:!0,controller:["$scope","$element","$attrs","$timeout","ModelChain",function(e,t,i,n,a){a.updateModel(e,i.name),e.showMenu=!1,e.prevDisabled=!0,e.nextDisabled=!0,e.initializing=!0,e.register=function(t){e.model.hasOwnProperty(t)||(e.model[t]=[])},e.build=function(t){var i=t.find(".swiper-container").first().swiper({calculateHeight:!0,pagination:t.find(".griot-repeater-pagination").first()[0],paginationClickable:!0,paginationElementClass:"griot-repeater-bullet",paginationActiveClass:"active",onSlideChangeStart:function(){e.refreshNav()},onSlideChangeEnd:function(){e.$broadcast("slideChange")},onInit:function(){e.$broadcast("slidesReady")},noSwiping:!0,noSwipingClass:"griot-prevent-swipe"});e.repeater=i},e.refreshNav=function(){n(0===e.repeater.activeIndex?function(){e.prevDisabled=!0}:function(){e.prevDisabled=!1}),n(e.repeater.activeIndex===e.repeater.slides.length-1?function(){e.nextDisabled=!0}:function(){e.nextDisabled=!1})},e.refresh=function(){n(function(){var t=e.repeater.slides.length;e.repeater.reInit();var i=e.repeater.slides.length;e.repeater.swipeTo(i>t&&!e.initializing?i-1:e.repeater.activeIndex),e.refreshNav()})},e.add=function(t){e.showMenu=!1,t.push({})},e.remove=function(t,i){e.showMenu=!1,t.splice(i,1)},e.rearrange=function(t,i,a){t.splice(a,0,t.splice(i,1)[0]),n(function(){e.repeater.swipeTo(a)})},e.toggleMenu=function(){e.showMenu=!e.showMenu},e.swipeToActive=function(){n(function(){e.repeater.swipeTo(e.repeater.activeIndex)})},this.refresh=function(){e.refresh()},this.add=function(t){e.add(t)},this.nextFocus=function(){e.nextDisabled||(e.repeater.swipeNext(),setTimeout(function(){jQuery(e.repeater.slides[e.repeater.activeIndex]).find("input,textarea").first().focus()},e.repeater.params.speed+10))},this.prevFocus=function(){e.prevDisabled||(e.repeater.swipePrev(),setTimeout(function(){jQuery(e.repeater.slides[e.repeater.activeIndex]).find("input,textarea").last().focus()},e.repeater.params.speed+10))},this.nextDisabled=function(){return e.nextDisabled},this.prevDisabled=function(){return e.prevDisabled},this.getActiveIndex=function(){return e.repeater.activeIndex},this.getRepeater=function(){return e.repeater},this.swipeTo=function(t){n(function(){e.repeater.swipeTo(t)})},this.stopInitializing=function(){e.initializing=!1}}],template:function(e,t){return"<div class='griot-field-wrap' data='data' ui='ui'><p class='griot-field-meta'><span class='griot-label'>"+t.label+"</span> <a class='griot-button' ng-click='add( model."+t.name+', "'+t.name+"\" )' >Add "+t.labelSingular+"</a></p><div class='griot-repeater'><div class='griot-repeater-header' ng-show='repeater.slides.length !== 0'><div class='griot-repeater-pagination'></div><span class='griot-repeater-nav griot-icon griot-icon-prev prev' ng-click='repeater.swipePrev()' ng-class=\"{'disabled':prevDisabled}\"></span><span class='griot-repeater-nav griot-icon griot-icon-next next' ng-click='repeater.swipeNext()' ng-class=\"{'disabled':nextDisabled}\"></span></div><div class='griot-repeater-container swiper-container'><div class='griot-repeater-wrapper swiper-wrapper'><div class='griot-repeater-item swiper-slide' ng-repeat='elem in model."+t.name+"'><div class='griot-repeater-meta-wrap'><span class='griot-repeater-meta'>"+t.labelSingular+"&nbsp;&nbsp;{{$index + 1}}&nbsp;&nbsp;of&nbsp;&nbsp;{{repeater.slides.length}}</span><a class='griot-repeater-menu-toggle griot-icon griot-icon-menu' ng-click='toggleMenu()' ng-class='{active:showMenu}'></a><div class='griot-repeater-menu' ng-show='showMenu'><div class='griot-repeater-menu-option'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-delete' ng-click='remove(model."+t.name+", $index)'></a><a class='griot-repeater-menu-option-label' ng-click='remove(model."+t.name+", $index)'>Delete "+t.labelSingular+"</a></div><div class='griot-repeater-menu-option' ng-class='{disabled:$index === 0}'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-shiftleft' ng-click='rearrange(model."+t.name+", $index, $index - 1)'></a><a class='griot-repeater-menu-option-label' ng-click='rearrange(model."+t.name+", $index, $index - 1)'>Shift left</a></div><div class='griot-repeater-menu-option' ng-class='{disabled:$index === repeater.slides.length - 1}'><a class='griot-repeater-menu-option-icon griot-icon griot-icon-shiftright' ng-click='rearrange(model."+t.name+", $index, $index + 1)'></a><a class='griot-repeater-menu-option-label' ng-click='rearrange(model."+t.name+", $index, $index + 1)'>Shift right</a></div></div></div><div class='griot-repeater-fields' ng-transclude></div></div></div></div></div></div>"},link:function(e,t,i){var n=this;e.register(i.name),e.build(t),e.refreshNav(),jQuery(window).on("click",function(i){var n=t.find(".griot-repeater-meta-wrap");jQuery(i.target).closest(".griot-repeater-meta-wrap").is(n)||e.$apply(e.showMenu=!1)}),e.$watchCollection(function(){return e.model[i.name]},function(){window.clearTimeout(n.checkModel),n.checkModel=window.setTimeout(function(){e.refresh()},10)})}}}]),angular.module("griot").directive("switch",["ModelChain",function(e){return{restrict:"E",replace:!0,controller:["$scope","$element","$attrs",function(t,i,n){t.model=e.getModel(t),t.model[n.name]=t.model[n.name]?t.model[n.name]:n.default,t.switchers=t.hasOwnProperty("switchers")?t.switchers:{},t.switchers[n.name]={"default":n.default,types:[]},this.registerType=function(e,i){-1===t.switchers[n.name].types.indexOf(e)&&t.switchers[n.name].types.push({name:e,label:i}),console.log("Registered "+e),console.log(t.switchers[n.name].types)},this.getSwitchName=function(){return n.name}}],template:function(e,t){var i=e.html(),n="<div class='griot-switch-wrap'><div class='griot-field-wrap'><div class='griot-field-meta'><span class='griot-label'>"+t.label+"</span><select ng-model='model[ \""+t.name+"\" ]' ng-options='type.name as type.label for type in switchers."+t.name+".types'></select></div></div>"+i+"</div>";return n},link:function(){}}}]),angular.module("griot").directive("switchgroup",["$compile","ModelChain",function(){return{restrict:"E",replace:!0,require:"^switch",controller:["$scope","$element","$attrs",function(e){e.isCurrentType=function(t){return t===e.model[e.switchName]}}],template:function(e,t){var i=e.html(),n="<div class='griot-switch-item' ng-show='isCurrentType(\""+t.type+"\")'>"+i+"</div>";return n},link:function(e,t,i,n){e.switchName=n.getSwitchName(),n.registerType(i.type,i.label)}}}]),angular.module("griot").directive("zoomer",["$http","ModelChain",function(e,t){return{restrict:"E",replace:!0,template:function(e,t){var i=e.html();t.hasAnnotations=i?!0:!1;var n="<div class='griot-annotated-image'><div class='griot-zoomer griot-prevent-swipe' id='zoomer"+Math.floor(1e6*Math.random())+"-{{$id}}' ng-class='{ hasAnnotations: hasAnnotations, noAnnotations: !hasAnnotations, isDroppable: isDroppable }' />";return i&&(n+="<repeater annotations label='"+t.annotationsLabel+"' name='"+t.annotationsName+"' label-singular='"+t.annotationsLabelSingular+"' label-plural='"+t.annotationsLabelPlural+"'>"+i+"</repeater>"),n+="</div>"},controller:["$scope","$element","$attrs","$timeout",function(t,i,n){var a=this;t.isDroppable=!1,t.checkForTiles=function(){var i=t.model[n.name];if(i!==t.imageID||"undefined"==typeof t.zoomer){if(!i)return void a.destroyZoomer(!0);t.tilejson=t.ui.tileServer+i+".tif";var o=e.get(t.tilejson);o.success(function(e){t.tileData=e,a.destroyZoomer(!0),a.setupZoomer(!0)}),o.error(function(){a.destroyZoomer(!0)})}},this.setupZoomer=function(e){"undefined"==typeof e&&(e=!1),t.imageID=t.model[n.name],t.tilesURL=t.tileData.tiles[0].replace("http://0","//0"),t.container_id=i.find(".griot-zoomer").first().attr("id"),e&&t.isVisible()&&t.buildZoomer()},t.buildZoomer=function(){t.imageLayers=L.featureGroup(),t.zoomer=Zoomer.zoom_image({container:t.container_id,tileURL:t.tilesURL,imageWidth:t.tileData.width,imageHeight:t.tileData.height}),t.zoomer.map._zoomAnimated=!1,t.zoomer.map.addLayer(t.imageLayers),a.loadImageAreas(),t.hasAnnotations&&(a.addDrawingControls(),a.watchForExternalDeletion())},this.destroyZoomer=t.destroyZoomer=function(e){"undefined"==typeof e&&(e=!1),t.zoomer&&(t.zoomer.map.remove(),delete t.zoomer,delete Zoomer.zoomers[t.container_id],e&&(i.find(".griot-zoomer").empty(),t.imageID=null,t.model.annotations=[]))},this.loadImageAreas=function(){angular.forEach(this.getAnnotations(),function(e){var i=e.geoJSON,n=L.GeoJSON.geometryToLayer(i.geometry);n.annotation=e,t.imageLayers.addLayer(n)})},this.addDrawingControls=function(){var e=new L.Control.Draw({draw:{circle:!1,polyline:!1,marker:!1,rectangle:{shapeOptions:{color:"#eee"}}},edit:{featureGroup:t.imageLayers}});t.zoomer.map.addControl(e)},this.watchForExternalDeletion=function(){t.$watchCollection(function(){return a.getAnnotations()},function(){"undefined"!=typeof t.zoomer&&angular.forEach(t.imageLayers._layers,function(e){-1===jQuery.inArray(e.annotation,a.getAnnotations())&&t.imageLayers.removeLayer(e)})})},this.getZoomer=function(){return t.zoomer?t.zoomer:null},this.getAnnotations=function(){return t.model[n.annotationsName]},t.zoomOut=function(){"undefined"!=typeof t.zoomer.map&&t.zoomer.map.centerImageAtExtents()},t.hasMap=function(){return t.zoomer?!0:!1},this.getScope=function(){return t},this.getImageLayers=function(){return t.imageLayers},t.isVisible=function(){var e=!0;return i.parents().each(function(t,i){$(i).hasClass("griot-repeater-item")&&!$(i).hasClass("swiper-slide-active")&&(e=!1)}),e}}],link:function(e,i,n){t.updateModel(e,n.name),e.hasAnnotations=n.hasAnnotations,e.imageID=e.model[n.name],e.checkForTiles(),i.find(".griot-zoomer").droppable({over:function(t,i){i.helper.data("image-id")!=e.model[n.name]&&e.isVisible()&&e.$apply(function(){e.isDroppable=!0})},out:function(){e.$apply(function(){e.isDroppable=!1})},drop:function(t,i){e.isVisible()&&i.helper.data("image-id")!=e.model[n.name]&&e.$apply(function(){e.isDroppable=!1,e.hasAnnotations&&e.model.annotations.length&&!confirm("This will destroy the "+e.model.annotations.length+" annotations attached to this view. Proceed?")||(e.model[n.name]=i.helper.data("image-id"),e.checkForTiles())})}}),e.$on("slidesReady",function(){e.isVisible()&&setTimeout(function(){"undefined"==typeof e.zoomer&&e.buildZoomer()},500)}),e.$on("slideChange",function(){"undefined"!=typeof e.zoomer&&e.destroyZoomer(!1),e.isVisible()&&"undefined"==typeof e.zoomer&&e.buildZoomer()})}}}]),L.extend(L.LatLngBounds.prototype,{toGeoJSON:function(){L.Polygon.prototype.toGeoJSON.call(this)},getLatLngs:function(){L.Polygon.prototype._convertLatLngs([[this.getSouthWest().lat,this.getSouthWest().lng],[this.getNorthWest().lat,this.getNorthWest().lng],[this.getNorthEast().lat,this.getNorthEast().lng],[this.getSouthEast().lat,this.getSouthEast().lng]])}}),angular.module("griot").filter("filterObjects",function(){return function(e,t,i){return t.zoomables?i?t.zoomables.objects[i]:t.zoomables.all:void console.log("WARNING: No config detected!")}}),angular.module("griot").filter("filterMediaByObject",["ModelChain",function(){return function(e,t,i){var n=[];return t?(angular.forEach(e,function(e){e.object_id==i&&n.push(e)}),n):e}}]),angular.module("griot").filter("getTitle",function(){return function(e){return""===e.post_title?"Untitled (post #"+e.ID+")":e.post_title}}),angular.module("griot").filter("parseInt",function(){return function(e){return parseInt(e)}}),angular.module("griot").factory("ModelChain",function(){return{initialize:function(e){e.modelChain=["data"],e.model=e.data},updateModel:function(e,t){e.modelChain=angular.copy(e.$parent.modelChain),"undefined"!=typeof e.$parent.$index&&e.modelChain.push(e.$parent.$index),e.model=e;for(var i=0;i<e.modelChain.length;i++)e.model=e.model[e.modelChain[i]];e.modelChain.push(t)},getModel:function(e){var t=angular.copy(e.$parent.modelChain);"undefined"!=typeof e.$index&&t.push(e.$index);for(var i=e,n=0;n<t.length;n++)i=i[t[n]];return i},bypassModel:function(e){e.modelChain=angular.copy(e.$parent.modelChain),"undefined"!=typeof e.$parent.$index&&e.modelChain.push(e.$parent.$index),e.model=e;for(var t=0;t<e.modelChain.length;t++)e.model=e.model[e.modelChain[t]]}}});